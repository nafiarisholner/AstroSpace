format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: android

app:
  envs:
    - PROJECT_LOCATION: "./"
    - MODULE: "app"
    - GRADLEW_PATH: "$PROJECT_LOCATION/gradlew"

trigger_map:
  - push_branch: "*"
    workflow: primary
  - pull_request_source_branch: "*"
    workflow: pr_check

workflows:
  primary:
    description: |
      Основной workflow — собирает Debug и Release APK, прогоняет тесты.
    steps:
      - git-clone@8: {}
      - install-missing-android-tools@3:
          inputs:
            - gradlew_path: "$GRADLEW_PATH"
      - gradle-runner@2:
          title: Run Unit Tests
          inputs:
            - gradle_task: ":$MODULE:testDebugUnitTest"
            - gradlew_path: "$GRADLEW_PATH"
      - gradle-runner@2:
          title: Build Debug APK
          inputs:
            - gradle_task: ":$MODULE:assembleDebug"
            - gradlew_path: "$GRADLEW_PATH"
      - gradle-runner@2:
          title: Build Release APK
          inputs:
            - gradle_task: ":$MODULE:assembleRelease"
            - gradlew_path: "$GRADLEW_PATH"
      - deploy-to-bitrise-io@2:
          inputs:
            - notify_user_groups: "everyone"

  pr_check:
    description: |
      Workflow для Pull Requests — тесты и Debug-сборка.
    steps:
      - git-clone@8: {}
      - install-missing-android-tools@3:
          inputs:
            - gradlew_path: "$GRADLEW_PATH"
      - gradle-runner@2:
          title: Run Unit Tests
          inputs:
            - gradle_task: ":$MODULE:testDebugUnitTest"
            - gradlew_path: "$GRADLEW_PATH"
      - gradle-runner@2:
          title: Build Debug APK
          inputs:
            - gradle_task: ":$MODULE:assembleDebug"
            - gradlew_path: "$GRADLEW_PATH"
      - deploy-to-bitrise-io@2: {}
