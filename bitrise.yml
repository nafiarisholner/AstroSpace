format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

project_type: android

app:
  envs:
    - PROJECT_LOCATION: "."
    - MODULE: "app"
    - BITRISE_PROJECT_PATH: "$PROJECT_LOCATION"

workflows:
  key:
    steps:
      - script@1:
          title: Add Key
          inputs:
            - content: |-
#!/bin/bash
set -e

# –ü—É—Ç—å –¥–ª—è keystore
KEYSTORE_PATH="$BITRISE_SOURCE_DIR/my-release-key.jks"

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ—Ä—ë–º –∏–∑ Secrets Bitrise
KEYSTORE_PASSWORD="HFGHFDGSDGDSGDSGH"
KEY_PASSWORD="HFGHFDGSDGDSGDSGH"
KEY_ALIAS="hgjfhgdgdgf"
DNAME="${DNAME:-CN=7424, OU=SG, O=SG, L=City, S=Region, C=MH}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ keystore
if [ -f "$KEYSTORE_PATH" ]; then
  echo "‚úÖ Keystore —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $KEYSTORE_PATH"
else
  echo "‚öôÔ∏è Keystore –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π..."
  keytool -genkeypair -v \
    -keystore "$KEYSTORE_PATH" \
    -storepass "$KEYSTORE_PASSWORD" \
    -keypass "$KEY_PASSWORD" \
    -keyalg RSA -keysize 2048 -validity 10000 \
    -alias "$KEY_ALIAS" \
    -dname "$DNAME"
  echo "‚úÖ Keystore —Å–æ–∑–¥–∞–Ω: $KEYSTORE_PATH"
fi

# –ö–æ–ø–∏—Ä—É–µ–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é deploy –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
mkdir -p "$BITRISE_DEPLOY_DIR"
cp "$KEYSTORE_PATH" "$BITRISE_DEPLOY_DIR/"

echo "üì¶ Keystore –≥–æ—Ç–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç"
       - deploy-to-bitrise-io@2:
          title: Deploy Key to Bitrise


  # --- –°–±–æ—Ä–∫–∞ .aab (release) ---
  build_aab:
    steps:
      - git-clone@8: {}
      
      - gradle-runner@2:
          title: Build AAB (bundleRelease)
          inputs:
            - gradle_task: "bundleRelease"

      - sign-apk@1:
          title: Sign Android App (AAB)
          inputs:
            - use_apk_signer: "true"
            # –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Bitrise –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
            # - keystore_url: "$BITRISEIO_ANDROID_KEYSTORE_URL"
            # - keystore_password: "$BITRISEIO_ANDROID_KEYSTORE_PASSWORD"
            # - keystore_alias: "$BITRISEIO_ANDROID_KEYSTORE_ALIAS"
            # - private_key_password: "$BITRISEIO_ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD"

      - deploy-to-bitrise-io@2:
          title: Deploy AAB to Bitrise

  # --- –°–±–æ—Ä–∫–∞ .apk (debug) ---
  build_debug_apk:
    steps:
      - git-clone@8: {}
      
      - gradle-runner@2:
          title: Build Debug APK
          inputs:
            - gradle_task: "assembleDebug"

      - sign-apk@1:
          title: Sign Android App (Debug)
          inputs:
            - use_apk_signer: "true"
            # –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ .apk

      - deploy-to-bitrise-io@2:
          title: Deploy Debug APK to Bitrise



